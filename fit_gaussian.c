/*
 * Program to test Gaussian fitting of waveform generated by EPICS and
 * Area Detector. The data has been saved to file, data.csv of a 299 x 299
 * beam projection from BL3.1 diagnostic beamline.
 *
 * The fit can also smooth the data first using gaussian smoothing kernal.
 */

#include <string.h>
#include <getopt.h> // required when using -std=c99
#include <unistd.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <gsl/gsl_vector.h>
#include <gsl/gsl_blas.h>
#include <gsl/gsl_multifit_nlinear.h>
#include <gsl/gsl_filter.h>
#include "fit_tools.h"

#define INFILE "data.bin"
#define IMG_SMOO "smoothed_image.ascii"
#define AVG_DATA "rows_cols_ave.ascii"
#define DATA_MODEL_X "data_model_x.ascii"
#define DATA_MODEL_Y "data_model_y.ascii"

int main(int argc, char **argv){
    // do not stop program if error occurs
    //gsl_set_error_handler_off();

	int smooth_opt = 1;
    int c;
	while ((c = getopt(argc, argv, "s")) != -1) {
        switch(c) {
            case 's':
                smooth_opt = 1;
                printf("Using Smoothing\n");
                break;
            default:
                abort();
        }
    }

    // need array of vectors to create a square
    gsl_vector* data_sq[DIM];
    load_data_from_file(INFILE, data_sq);
    gsl_filter_gaussian_workspace *gauss_p = gsl_filter_gaussian_alloc(K_SIZE);

    if (smooth_opt == 1) {
        smooth_data_sq(data_sq, gauss_p);
        save_smoothed_image(IMG_SMOO, data_sq);
        gsl_filter_gaussian_free(gauss_p);
    }

    // Mean of rows and cols
    //  X dim
    gsl_vector *mux = gsl_vector_alloc(DIM);
    average_dim(data_sq, mux, 0);

    // Y dim
    gsl_vector *muy = gsl_vector_alloc(DIM);
    average_dim(data_sq, muy, 1);

    // save both x and y averages
    save_averaged_to_file(AVG_DATA, mux, muy);

    // Guassian Fit
    FinalPos *fpx = malloc(sizeof(FinalPos));
    Data *fit_data_x = malloc(sizeof(Data));
    fit_data_x->t = malloc(DIM * sizeof(double));
    fit_data_x->y = malloc(DIM * sizeof(double));
    fit_data_x->n = DIM;
    fit(mux, fpx, fit_data_x, 0);

    //save ascii data to file
    save_data_and_model(DATA_MODEL_X, fpx, fit_data_x);

    FinalPos *fpy = malloc(sizeof(FinalPos));
    Data *fit_data_y = malloc(sizeof(Data));
    fit_data_y->t = malloc(DIM * sizeof(double));
    fit_data_y->y = malloc(DIM * sizeof(double));
    fit_data_y->n = DIM;
    fit(muy, fpy, fit_data_y, 1);

    save_data_and_model(DATA_MODEL_Y, fpy, fit_data_y);

    // clean up
    for (int i=0; i < DIM; i++) {
        gsl_vector_free(data_sq[i]);
    }

    gsl_vector_free(mux);
    gsl_vector_free(muy);
    free(fpx);
    free(fpy);
    free(fit_data_x);
    free(fit_data_y);

    return 0;
}
